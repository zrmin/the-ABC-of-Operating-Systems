<h1><center>一、操作系统概述</center></h1>

1.1 操作系统的概念、特征、功能和服务

1.1.1 操作系统概念

OS是系统软件，程序模块的集合，资源管理和用户接口功能



操作系统的目标（不同视角）：

* 方便性（用户的观点）

提供良好的、一致的用户接口，弥补硬件系统的类型和数量差别，使计算机更容易使用

* 有效性（系统管理人员的观点）

使CPU、I/O设备和存储空间得到有效利用；管理和分配软、硬件资源，合理地组织计算机的工作流程

* 可扩充性

OS应采用层次化结构，以便于增加新的功能层次和模块，并能修改老的功能层次和模块

* 开放性

遵循标准规范，方便地实现互联，实现应用的可移植性和互操作性



1. OS作为用户与计算机硬件系统间的接口

* OS处于用户与计算机硬件系统之间，用户通过OS来使用计算机系统
* 系统方式（命令接口）
  * 命令行
  * 菜单式
  * 命令脚本式
* 系统调用（程序接口）
  * 形式上类似于过程调用
  * 在应用编程中使用
* 图形用户接口
  * 图形、窗口等

2. OS作为计算机系统资源的管理者

* 计算机的硬件资源包括处理机、存储器、I/O设备及数据和程序等
* 管理的内容：资源的当前状态（数量和使用情况）、资源的分配、回收和访问操作，相应的管理策略（包括用户权限）
  * CPU管理
  * 存储器管理
  * I/O设备管理
  * 文件管理

3. OS用作扩充机器

* OS是扩展机（extended machine）/虚拟机（virtual machine）
  * 将覆盖了软件的机器成为扩展机或虚拟机
* 在裸机上添加：设别管理、文件管理、存储管理（针对内存和外存）、CPU管理
* 合理组织工作流程：作业管理、进程管理

<font color = red>操作系统的非形式化定义（关键点）：系统软件，程序模块的集合，资源管理和用户接口功能</font>



1.1.2 操作系统的基本特征

* 并发性（Concurrence）
* 共享（Sharing）
* 虚拟（Virtual）
* 异步性（Asynchronism）

（注意：这里指的是通用操作系统）

并发：

* 并发指的是多个事件在<font color=blue>同一时间段内</font>发生。操作系统是一个并发系统，各进程间的并发，系统与应用间的并发。操作系统要完成这些并发过程的管理
* 并行parallel是指在<font color=blue>同一时刻</font>发生
* 在多道程序处理时，宏观上并发，微观上交替执行（在单处理器情况下）
* 程序的静态实体是可执行文件，而动态实体是进程（或称作任务），并发指的是进程（或线程）

（注意：区分并发和并行）

共享：

* 是指系统中的资源可供内存中多个并发执行的进程（线程）共同使用。因资源属性不同，对资源共享的方式也不同
* 互斥共享（如音频设备、打印机等）
  * 资源分配后释放前，不能被其他进程所用
* 同时访问（如可重入代码，磁盘文件）
  * 同时是宏观上，在微观上进程可能是交替地对资源进行访问

（注意：并发和共享是相互依存的）

* 并发和共享是操作系统的两个最基本的特征
  * 一方面，资源共享是以程序（进程）的并发执行为条件的
  * 另一方面，若系统不能对资源共享实施有效管理，协调好诸进程对共享资源的访问，也必然影响到程序并发执行的程度

虚拟性：

* 通过某种技术把一个物理实体变为若干个逻辑上的对应物，提高资源的利用率
  * CPU——每个用户（进程）的“虚处理机”——PCB
  * 存储器——每个进程都占有的地址空间（指令+数据+堆栈）
  * 显示设备——多窗口或虚拟终端（virtual terminal）
  * 打印设备——将临界资源变为同时访问资源

异步性：

* 不确定性：进程的执行顺序和执行时间的不确定性
  * 进程的运行速度不可预知：分时系统中，多个进程并发执行，“时走时停”，不可预知每个进程的运行推进快慢
* 判据：无论快慢，应该结果相同——通过进程互斥和同步手段来保证
  * 难以重现系统在某个时刻的状态（包括重现运行中的错误）
* 性能保证：实时系统与分时系统相似，但通过资源预留以保证性能



1.1.3 操作系统的主要功能

* CPU管理
* 存储器管理
* 设备管理
* 文件管理
* 用户管理



CPU管理

* 完成CPU资源的分配、回收调度等功能
* CPU调度的单位可为进程或线程
* 进程控制
  * 创建、撤销、挂起、改变运行优先级等
* 进程同步
  * 协调并发进程之间的推进步骤，以协调资源共享
  * 互斥方式，诸进程访问临界资源时采用这种方式
  * 同步方式，在相互合作完成任务的进程之间由同步机构对执行次序加以协调

* 进程通信
  * 负责进程之间传送数据，以协调进程间的协作
  * 如，输入进程、计算进程、打印进程之间的通信
* 进程调度
  * 作业和进程的运行切换，以充分利用CPU资源和提高系统性能
  * 作业调度从外存调入内存
  * 进程协调是从内存中的进程就绪队列中选一个分配CPU
  * 在多线程OS中，要考虑线程调度
  * 考虑同一类型内的公平性、高效率（吞吐量大）、作业或进程的周转时间等

存储器管理

* 管理目标
  * 提高利用率、方便用户使用、提供足够大的存储空间、方便进程并发执行
* 内存分配
  * 为每道程序分配空间：静态分配、动态分配
  * 提高利用率
  * 允许正在运行程序申请附加空间
* 内存保护
  * 确保每道用户程序都只在自己的内存空间内运行、互不干扰
  * 如：访问合法性检查、甚至要防止从“垃圾”中窃取其他进程的信息
  * 一种方法是设置两个界限寄存器，由硬件实现越界检查
* 地址映射
  * 程序中的地址成为“逻辑地址”或“相对地址”
  * 内存中单元的地址成为“物理地址”
  * 多道程序下，进程装入内存后要由逻辑地址到内存物理地址进行变换
* 内存扩充
  * 借助于虚拟存储技术，从逻辑上去扩充内存容量
  * 改善了系统的性能，基本上不增加硬件投资
  * 请求调入功能
  * 置换功能

设备管理

* 管理目标
  * 方便的设备使用、提高CPU与I/O设备利用率、提高I/O速度
* 缓冲区管理
  * 匹配CPU和外设的速度，提高两者的利用率
  * 单缓冲、双缓冲、公共缓冲池
* 设备分配与回收
  * 在多用户间共享I/O设备资源
  * 针对不同类型设备采用不同策略，如独占设备分配
  * 虚拟设备（virtual device）：设备由多个进程共享，每个进程如同独占
* 设备独立性
  * 用户申请的设备与实际操作的物理设备无关

文件管理

* 管理目标
  * 对用户文件和系统文件进行管理，以方便用户使用并保证文件安全
* 文件存储空间管理里
  * 解决如何存放信息，以提高空间利用率和读写性能
  * 存储空间的使用情况，空间分配与回收
* 目录管理
  * 解决信息检索问题，能按名存取
  * 目录项包括文件名、文件属性、文件在磁盘上的物理位置等
* 文件读写
  * 根据用户请求，从外存中读取数据；或将数据写入外存
* 文件保护
  * 解决信息安全问题
  * 防止未经核准的用户存取文件
  * 防止冒名顶替存取文件
  * 防止以不正确的方式使用文件

用户接口

* 目标
  * 提供一个友好的用户访问操作系统的接口
* 命令接口
  * 联机用户接口 这是为联机用户提供的，它由一组键盘操作命令及命令解释程序所组成
  * 脱机用户接口 该接口是为批处理作业的用户提供的，故也称为批处理用户接口。该接口由一组作业控制语言JCL组成
* 程序接口
  * 该接口是为用户程序在执行中访问系统资源而设置的，是用户程序取得操作系统服务的唯一途径。它是由一组系统调用组成，每一个系统调用都是一个能完成特定功能的子程序
* 图形接口
  * 图形用户接口采用了图形化的操作界面，用非常容易识别的各种图标（icon）来将系统的各项功能、各种应用程序和文件，直观、逼真地表示出来



1.2 操作系统地发展与分类

1..2.1 操作系统的发展过程

* 无操作系统的计算机系统
* 单道批处理系统
* 多道批处理系统
* 分时系统
* 实时系统
* 网络操作系统
* 分布式操作系统
* 嵌入式操作系统

人工操作方式

* 1946~50年代（电子管），集中计算（计算中心），计算机资源昂贵

* 工作方式

  * 用户：用户既是程序员，又是操作员；用户是计算机专业人员
  * 编程语言：机器语言
  * 输入输出：纸带或卡片

* 计算机的工作特点

  * 用户独占全机：不出现资源被其他用户占用，资源利用率低
  * CPU等待用户：计算前，手工装入纸带或卡片；计算完成后，手工卸取纸带或卡片；CPU利用率低

  <font color=red>严重降低了计算机资源的利用率——人机矛盾</font>

硬件不断发展，CPU速度提高、系统规模扩大，人机矛盾严重，如何解决？

脱机输入/输出（Off-Line I/O）方式

* 事先将用户程序或数据的纸带或卡片输入纸带输入机，在外围机的控制下输入到磁带上，CPU从磁带上读入数据；输出过程正好相反
* 特点：
  * 减少CPU的空闲时间
  * 提高I/O速度

无操作系统的主要问题：

* 主要矛盾
  * 计算机处理能力的提高，手工操作的低效率（造成浪费）
  * 用户独占全机的所有资源
* 提高效率的途径
  * 专门的操作员
  * 批处理

单道批处理系统（Simple Batch Processing System）

* 50年代末~60年代中（晶体管）：利用磁带把若干个作业分类编成作业执行序列，每个批作业由一个专门的监督程序（Monitor）自动依次处理。可使用汇编语言开发
* 批处理中的作业的组成
  * 用户程序
  * 数据
  * 作业说明书（作业控制语言）
* 批
  * 供一次加载的磁带或磁盘，通常由若干个作业组装成，在处理中使用一组相同的系统软件（系统带）

两种批处理方式——联机批处理

* 用户提交作业：以纸带或卡片为介质
* 操作员合成批作业：结果为磁带介质
* 批作业处理：对批作业中的每个作业进行相同的处理：从磁带读入用户作业和编译链接程序，编译链接用户作业，生成可执行程序；启动执行；执行结果输出
* 问题：慢速的输入输出处理仍直接由主机来完成。输入输出时，CPU处于等待状态

两种批处理方式——脱机批处理

* 卫星机：完成面向用户的输入输出（纸带或卡片），中间结果暂存在磁带或磁盘上
* 卫星机完成输入输出功能。主机与卫星机可并行工作
* 作业控制命令由监督程序（monitor）来执行，完成如装入程序、编译、运行等操作
* 优点：同一批内各作业的自动依次更替，改善了主机CPU和I/O设备的使用效率，提高了吞吐量
* 缺点：磁带或磁盘需要人工装卸，作业需要人工分类，监督程序易遭到用户程序的破坏（由人工干预才可恢复）

单道批处理系统的特征

* 自动性
  * 在顺利的情况下，磁带上的一批作业能自动地逐个地依次运行，而无需人工干预
* 顺序性
  * 磁带上的各道作业是顺序地进入内存，完成顺序与进入内存顺序相同
* 单道性
  * 内存中只有一道程序运行
* CPU和I/O设备忙闲不均（取决于当前作业）
  * 对计算为主的作业，外设空闲
  * 对I/O为主的作业，CPU空闲

多道批处理系统（Multiprogramed Batch System）

CPU、I/O设备忙闲不均、内存利用率低，如何解决？

* 60年代~70年代中（集成电路），利用多道批处理提高资源的利用率——现代操作系统的雏形
* 多道批处理的运行特征
  * 多道：内存中同时存放几个作业，并允许并发执行，从而有效地提高了资源利用率和系统吞吐量
  * 无序性：多个作业完成的先后顺序与它们进入内存的顺序之间无严格对应关系
  * 调度性：作业调度，从后备队列进入内存；进程调度，分配CPU运行
* 举例
  * 在当前运行的作业需作I/O处理时，CPU转而执行另一个作业

多道批处理系统的特征

* 多道性
  * 多道程序驻留内存：提高了资源的利用率
  * 程序并发执行：提高了系统的吞吐量
* 无序性
  * 作业进入内存先后顺序和完成的先后顺序无对应性
* 调度性
  * 作业提交给系统需经过两次调度
  * 作业调度
  * 进程调度

|          |      单道      |             多道             |
| :------: | :------------: | :--------------------------: |
| 内存使用 |  每次一个作业  | 每次多个作业（充分利用内存） |
| 作业次序 | 顺序，先进先出 |          无确定次序          |

|                                      | 单道批处理 | 多道批处理 |
| :----------------------------------: | :--------: | :--------: |
|          内存中驻留程序数目          |    一道    |    多道    |
|            占用CPU的情况             |    独占    |  交替占用  |
|        是否需要作业和进程调度        |   不需要   |    需要    |
| 程序完成次序与其进入内存次序间的关系 |  严格对应  | 不严格对应 |

多道批处理系统的特点

* 优点
  * 资源利用率高：CPU、I/O设备和内存利用率较高
  * 作业吞吐量大：单位时间内完成的工作总量大
* 缺点
  * 用户交互性差：整个作业完成后或中间出错时，才与用户交互，不利于调试和修改
  * 作业平均周转时间成：短作业的周转时间显著增长

多道批处理系统需要解决的问题

* CPU管理：如何共享、分配及回收处理机、提高利用率
* 内存管理：如何分配、互不重叠及干扰
* I/O设备管理：如何共享及分配、方便用户、提高利用率
* 文件管理：如何组织数据和程序、便于使用、保证数据的安全性及一致性
* 作业管理：如何根据作业类型进行组织

<font color=red>操作系统是一组控制和管理计算机硬件和软件资源，合理地对各类作业进行调度，以及方便用户使用地程序集合</font>

分时系统（Time-Sharing System）

* 产生原因：用户需要
  * 人机交互
  * 共享主机
  * 便于用户上机：远程联机
* 70年代中期至今
* 把计算机的系统资源（尤其是CPU时间）进行时间上的分割，每个时间段称为一个<font color=red>时间片</font>（time slice），每个用户依次轮流使用时间片。

分时系统（Time-Sharing System）

* ”分时“的含义是指多个用户分享使用同一台计算机；多个程序分时共享硬件和软件资源
  * 多个用户分时：单个用户使用计算机的效率低，因而允许多个应用程序同时在内存中，分别服务于不同的用户
  * 前台和后台程序分时：后台程序不占用终端输入输出，不与用户交互
  * 按时间片分配：各个程序在CPU上执行的轮换时间

分时系统中的关键问题

* 使用户能与自己作业进行交互是分时系统的关键问题
  * 及时接收：多路卡
  * 及时处理：作业直接进入内存，时间片轮转
* 为了实现交互，用户作业必须及时进入内存；不允许一个作业长期占用CPU，须按时间片分配

分时系统的特征

* 多路性
  * 共享系统资源，提高了资源利用率。节省维护开支，可靠性高。远地用户通过终端（较便宜）联机使用
* 独立性
  * 每个用户一台终端，互不干扰，感觉像一个人独占计算机
* 及时性
  * 用户请求尽快得到相应
* 交互性
  * 用户可通过终端与系统进行广泛的人机对话，请求系统提供多方面的服务，如文件编辑、数据处理、资源共享等
  * 系统能及时对用户的操作进行响应，显著提高调试和修改程序的效率：缩短了周转时间

实时系统（Real-Time System）

* 工业过程控制、军事实时控制、金融等领域，包括
  * 实时控制：当计算机应用于生产过程的控制形成以计算机为中心的控制系统时，系统要求能实时采集现场数据，并对所采集的数据进行及时处理，从而自动地控制相应的执行机构，使某些参数（如湿度、压力、液位）能按预定的规律变化，以保证产品的质量和提高产量。
  * 实时信息处理：能及时接收从远程终端发来的服务请求，对信息进行检索和处理，在很短时间内做出回答
* 主要设计目标：响应时间短；实时时钟管理；连接人机对话；过载防护；高度可靠性和安全。
* 任务的类型
  * 周期性实时任务
  * 非周期性实时任务：截止时间（deadline），开始截止时间（最晚开始时间）和完成截止时间（最晚完成时间）
* 对截止时间的要求
  * 硬实时任务（hard real-time task）：必须满足截止时间要求
  * 软实时任务（soft real-time task）
* 通常把兼有分时、实时和批处理三者或者其中两者的操作系统，称作<font color=red>通用操作系统</font>。可适用计算、事务处理等多种领域，能运行于多种硬件平台上，如UNIX系统、Windows NT等。——通用化、小型化。



<center>实时系统与分时系统的比较</center>

|        |          分时系统          |             实时系统             |
| :----: | :------------------------: | :------------------------------: |
| 多路性 |         多终端服务         | 多路现场、多个对象、多个执行机构 |
| 独立性 | 终端服务互相独立、互不干扰 |    信息采集和对象控制互不干扰    |
| 及时性 |        用户可接受的        |        实时控制系统要求高        |
| 交互性 |             强             |           仅对特定任务           |
| 可靠性 |            一般            |       强，通常采用容错措施       |



现代操作系统

* 网络
* 分布式
* 嵌入式

<center>网络操作系统</center>

计算机网络：通过通信设施将物理上分散的具有自治功能的多个计算机系统互连起来的实现信息交换、资源共享、可互操作和协作处理的系统。

网络操作系统

1. 在各种计算机操作系统上，按网络体系结构协议标准开发的软件
2. 包括网络管理、通信、安全、资源共享和各种网络应用
3. 目标：相互通信及资源共享



<center>分布式操作系统</center>

1. 基于两种环境：

   * 多处理器系统
   * 多计算机系统

2. 是网络操作系统的更高级的形式

3. 保持了网络操作系统的全部功能

4. 特征：

   （1）是一个统一的操作系统

   （2）资源进一步共享

   （3）透明性：资源共享与分布对用户是透明的

   （4）自治性：处于分布式系统的多个主机处于平等地位，无主从关系

   （5）处理能力增强、速度更快、可靠性增强

5. 网络和分布式的区别

   * 分布式具有各个计算机间相互通讯，无主从关系；网络具有主从关系
   * 分布式系统资源为所有用户共享；而网络有限制地共享
   * 分布式系统中若干个计算机可相互协作共同完成一项任务



<center>嵌入式操作系统</center>

嵌入式系统

* 在各种设备、装置或系统中，完成特定功能的软硬件系统
* 它们是一个大设备、装置或系统中的一部分，这个大设备、装置或系统可以不是”计算机“
* 由于它们被嵌入在各种设备、装置或系统中，因此被称为嵌入式系统



EOS（Embedded Operating System）在嵌入式系统中的OS

* 是运行在嵌入式智能芯片环境中

* 对整个智能芯片以及它所操作、控制的各种部件装置等资源进行统一协调、调度、指挥和控制的系统软件

* 国际上有名的嵌入式操作系统有Windows CE、Palm OS、Linux、VxWorks、pSOS、QNX、OS-9、LynxOS,Android，IOS，win10等。



典型嵌入式操作系统的特性

* 完成某一项或有限项功能；不是通用型的
* 在性能和实时性方面有严格的限制
* 能源、成本和可靠性通常是影响设计的重要因素
* 占有资源少、易于连接
* 系统功能可针对需求进行裁剪、调整和生成，以便满足最终产品的设计要求



1.2.2 操作系统的分类

1. 单用户单任务操作系统

DOS的全称是Disk Operation System。

1973年，技术天才Cary Killdal和两名合作者一起开发出了第一个磁盘操作系统CP/M，这是70年代末、80年代初最有影响的8位操作系统。

在次基础上，Seattle Computer Products(SCP)的Tim Patterson于1978年开始开发QDOS，此后又成功研制出16位微型机的实验性操作系统86-DOS。

DOS和它的接班人

* 1981年，花费半年时间编写的MS-DOS 1.0和IBM PC同时在IT界亮相，但其兼容性仍受到业界怀疑。
* 1987年，MS-DOS 3.3发布，它的流行确立了MS-DOS的霸主地位。MS-DOS的最后版本为MS-DOS 6.22，这是一个相当成熟的系统
* 后来的DOS整合到Windows 9x中了，在Windows的命令行模式中可以看到它的影子。Microsoft渐渐疏远DOS之后，IBM公司继续开发自己的PC-DOS。

2. 单用户多任务操作系统

单用户多任务操作系统的含义是，只允许一个用户上机，但允许用户把程序分为若干个任务，使它们并发执行，从而有效地改善了系统的性能。

* Windows XP  win10
* 1970年，美国Xerox公司成立了著名的研究机构Palo Alto研究中心。Apple公司的创始人之一Steve Jobs参观该研究中心时看到了可以支持GUI（Graphical User Interfaces）和三键鼠标的Alto原型，便着手进行自己的GUI系统研究开发工作
* 1983年第一个GUI系统Apple Lisa开发出来了，第二年推出的Apple Macintosh是世界上第一个成功的商用GUI系统。当时Apple公司只开发了自己微机上的GUI系统，这样就给Microsoft开发Windows提供了机会

3. 多用户多任务操作系统

多用户多任务操作系统的含义是，允许多个用户通过各自的终端，使用同一台机器，共享主机系统中的各种资源，而每个用户程序又可进一步分为几个任务，使它们能并发执行，从而可进一步提高资源利用率和系统吞吐量。

在大、中、小型机中所配置的大多是多用户多任务操作系统，而在32位微机上，也有不少配置的是多用户多任务操作系统，其中最有代表性的是UNIX OS。

UNIX家族及类UNIX系统

* 1969年，在AT&T的Bell Labs，Ken Thompson和Dennis Ritchie（他们曾是大型操作系统Multics的两名开发者，Multics太庞大了最终没有成功）为了一项名为太空旅游计划的实验计划，需要一个操作系统。他们找了一台闲置的PDP-7机器，在上面写了个Multics的改编版，1971年正式发布。这个东西就是后来名扬天下的UNIX了。

Linux

* 1991年，芬兰学生Linus Toralds开始使用MINIX时，对MINIX提供的功能不满意。于是他自己写了一个类UNIX操作系统（尽管还是MINIX编译的）并放到网上让人们自由下载，取名叫Linux
* Linux刚出现的时候是被Tanenbaum所鄙视的，因为它是集成化内核，不是MINIX采用的代表先进思想的微内核；但由于遵循GPL协议，Linux仍得到了蓬勃发展

操作系统举例

1. MS(MicroSoft) OS：MS DOS、MS windows 3.x, Windows 95,Windows NT, Windows 98, Windows 2000, Windows Me, Windows XP, Windows 2003, Windows Vista, Win 7, Win8, Win10/

2. UNIX: BSD, SRV4, OSF1, SCO UNIX, AIX, Solaris, Linux, ubuntu
3. NOS: Novell Netware
4. RTOS: VxWorks, pSOS, Nucleus
5. Embed: IOS, Android, Cos



1.3 操作系统的运行环境

特权指令：有少数指令是为编制系统管理程序专门设置的，只有操作系统才能使用。如果用户误用这些特权指令，称为非法指令，将引发故障中断。

（1）有关I/O的指令

（2）访问程序状态字寄存器的指令

（3）存取特殊寄存器（如用于内存保护的寄存器）的指令

（4）其他访问系统状态和直接访问系统资源的指令等



CPU处理器的状态

1. 目态：程序执行时不可使用特权指令，I/O指令、时钟设置、中断机制、系统管理等
   * 用户程序运行时的状态，较低的特权级别
   * 普通态（普态）、用户态
2. 管态：程序执行时可以使用特权指令
   * 执行系统管理程序
   * 特权态、系统态、内核态、核心态



CPU如何判断用户程序和系统程序

1. 程序状态字PSW

* 记录CPU的运行模式和状态信息
* 一类是反映当前指令执行结果的各种状态信息，称为状态标志，如进位标志位CF、溢出标志位OF、结果正负标志位SF、结果是否为0标志位ZF、奇偶标志位PF等
* 一类存放控制信息，称为空置状态，如中断标志位IF、CPU的工作状态位（核心态还是用户态）等



状态如何转变

1. 核心态到用户态——修改PSW

2. 用户态到核心态——用户不能修改PSW，通过系统调用、访管指令

   （1）通过中断实现从用户态到核心态的改变

   （2）在核心态下由操作系统代替用户完成其请求（指定的操作）

   （3）操作系统完成指定操作后再通过修改程序状态字PSW由核心态切换回用户态

访管指令不是特权指令

* 用户从用户态进入内核态必定通过访管指令
* 从内核态返回用户态可以修改状态字实现

